name: Generate Weekly KVMARM Report

on:
  # æ¯å‘¨ä¸€ä¸Šåˆ9ç‚¹ï¼ˆä¸œå…«åŒº UTC+8ï¼‰= UTC æ—¶é—´å‘¨ä¸€å‡Œæ™¨1ç‚¹
  schedule:
    - cron: '0 1 * * 1'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      start_date:
        description: 'èµ·å§‹æ—¥æœŸ (YYYY-MM-DD, å¯é€‰)'
        required: false
        type: string
      end_date:
        description: 'ç»“æŸæ—¥æœŸ (YYYY-MM-DD, å¯é€‰)'
        required: false
        type: string
      use_ai:
        description: 'ä½¿ç”¨ AI æ€»ç»“'
        required: false
        type: boolean
        default: false

# è®¾ç½®æƒé™
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install openai anthropic

      - name: Clone KVMARM mailing list
        run: |
          echo "ğŸ“¥ Cloning KVMARM mailing list repository..."
          mkdir -p git
          if [ -d "git/0.git" ]; then
            echo "Repository exists, fetching updates..."
            cd git/0.git
            git fetch --all
            cd ../..
          else
            git clone --mirror https://lore.kernel.org/kvmarm/0 git/0.git
          fi

          # æ£€æŸ¥ä»“åº“å¤§å°
          du -sh git/0.git
          echo "âœ… Mailing list repository ready"

      - name: Generate weekly report
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ¤– Generating weekly report..."

          # åˆ¤æ–­æ˜¯æ‰‹åŠ¨è§¦å‘è¿˜æ˜¯å®šæ—¶è§¦å‘
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘
            if [ -n "${{ inputs.start_date }}" ]; then
              # æ‰¹é‡ç”Ÿæˆ
              START_ARG="--start ${{ inputs.start_date }}"
              END_ARG=""
              if [ -n "${{ inputs.end_date }}" ]; then
                END_ARG="--end ${{ inputs.end_date }}"
              fi
            else
              # ç”Ÿæˆæœ¬å‘¨
              START_ARG=""
              END_ARG=""
            fi

            # AI é€‰é¡¹
            if [ "${{ inputs.use_ai }}" = "true" ]; then
              AI_ARG="--ai openai --model gpt-4o-mini"
            else
              AI_ARG="--ai none"
            fi
          else
            # å®šæ—¶è§¦å‘ï¼šåªç”Ÿæˆæœ¬å‘¨ï¼Œä½¿ç”¨ AI
            START_ARG=""
            END_ARG=""
            AI_ARG="--ai openai --model gpt-4o-mini"
          fi

          # æ‰§è¡Œç”Ÿæˆ
          python3 analyze_with_ai_summary.py $START_ARG $END_ARG $AI_ARG

          echo "âœ… Report generated successfully"

      - name: Create index redirect
        run: |
          echo "ğŸ“„ Creating index.html redirect to current week..."

          # è·å–å½“å‰å‘¨ä¿¡æ¯
          YEAR=$(date +%Y)
          WEEK=$(date +%V)
          CURRENT_WEEK_FILE="kvmarm_${YEAR}_week${WEEK}.html"

          # åˆ›å»º index.html é‡å®šå‘åˆ°å½“å‰å‘¨
          cat > docs/index.html << 'EOFHTML'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KVMARM Mailing List - Current Week</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #f5f5f5;
        }
        .container {
            text-align: center;
            padding: 40px;
            background: white;
            border: 2px solid #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #000;
        }
        p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }
        .links {
            margin-top: 30px;
        }
        a {
            display: inline-block;
            margin: 10px;
            padding: 12px 24px;
            background: #333;
            color: white;
            text-decoration: none;
            border: 2px solid #333;
            transition: all 0.3s;
        }
        a:hover {
            background: #000;
            transform: translateY(-2px);
        }
    </style>
    <script>
        // è‡ªåŠ¨é‡å®šå‘åˆ°å½“å‰å‘¨
        window.onload = function() {
            const now = new Date();
            const year = now.getFullYear();

            // è®¡ç®— ISO å‘¨æ•°
            const startOfYear = new Date(year, 0, 1);
            const days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
            const week = Math.ceil((days + startOfYear.getDay() + 1) / 7);

            const weekStr = week.toString().padStart(2, '0');
            const currentWeekFile = `kvmarm_${year}_week${weekStr}.html`;

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('current-week-text').textContent = `${year} Week ${week}`;
            document.getElementById('current-week-link').href = currentWeekFile;

            // 3ç§’åè‡ªåŠ¨è·³è½¬
            setTimeout(() => {
                window.location.href = currentWeekFile;
            }, 3000);
        };
    </script>
</head>
<body>
    <div class="container">
        <h1>KVMARM Mailing List</h1>
        <p>Redirecting to current week report in 3 seconds...</p>
        <div class="links">
            <a id="current-week-link" href="#">ğŸ“… Current Week (<span id="current-week-text">Loading...</span>)</a>
            <a href="archive.html">ğŸ“š Archive</a>
        </div>
    </div>
</body>
</html>
EOFHTML

          echo "âœ… Index page created: docs/index.html"

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Commit and push reports
        run: |
          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          git add docs/*.html docs/*.md

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            # æäº¤å˜åŒ–
            YEAR=$(date +%Y)
            WEEK=$(date +%V)
            git commit -m "chore: Generate weekly report ${YEAR}W${WEEK}

Generated by GitHub Actions
Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
"

            # æ¨é€åˆ°ä»“åº“
            git push
            echo "âœ… Reports committed and pushed"
          fi

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    needs: generate-report
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
