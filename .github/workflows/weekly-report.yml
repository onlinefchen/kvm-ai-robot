name: Generate Weekly KVMARM Report

on:
  schedule:
    - cron: '0 1 * * 1'
  
  workflow_dispatch:
    inputs:
      start_date:
        description: 'èµ·å§‹æ—¥æœŸ (YYYY-MM-DD, å¯é€‰ï¼Œé»˜è®¤ç”Ÿæˆæœ¬å‘¨)'
        required: false
        type: string
      end_date:
        description: 'ç»“æŸæ—¥æœŸ (YYYY-MM-DD, å¯é€‰ï¼Œé»˜è®¤åˆ°ä»Šå¤©)'
        required: false
        type: string
      force_regenerate:
        description: 'å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼ˆè¦†ç›–å·²å­˜åœ¨çš„å†å²æŠ¥å‘Šï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install openai anthropic

      - name: Clone KVMARM mailing list
        run: |
          echo "ğŸ“¥ Cloning KVMARM mailing list repository..."
          mkdir -p git
          if [ -d "git/0.git" ]; then
            echo "Repository exists, fetching updates..."
            cd git/0.git
            git fetch --all
            cd ../..
          else
            git clone --mirror https://lore.kernel.org/kvmarm/0 git/0.git
          fi
          du -sh git/0.git
          echo "âœ… Mailing list repository ready"

      - name: Generate weekly report
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ¤– Generating weekly report..."
          
          # è®¾ç½®æ—¥æœŸå‚æ•°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘
            if [ -n "${{ inputs.start_date }}" ]; then
              START_ARG="--start ${{ inputs.start_date }}"
              END_ARG=""
              if [ -n "${{ inputs.end_date }}" ]; then
                END_ARG="--end ${{ inputs.end_date }}"
              fi
            else
              START_ARG=""
              END_ARG=""
            fi
          else
            # å®šæ—¶è§¦å‘ï¼šåªç”Ÿæˆæœ¬å‘¨
            START_ARG=""
            END_ARG=""
          fi
          
          # è‡ªåŠ¨æ£€æµ‹æ˜¯å¦ä½¿ç”¨ AI
          if [ -n "$OPENAI_API_KEY" ]; then
            echo "âœ… æ£€æµ‹åˆ° OPENAI_API_KEYï¼Œä½¿ç”¨ AI æ€»ç»“"
            AI_ARG="--ai openai --model gpt-4o-mini"
          else
            echo "â„¹ï¸  æœªæ£€æµ‹åˆ° OPENAI_API_KEYï¼Œä½¿ç”¨åŸºäºè§„åˆ™çš„æ€»ç»“"
            AI_ARG="--ai none"
          fi

          # æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
          FORCE_ARG=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.force_regenerate }}" = "true" ]; then
            echo "ğŸ”„ å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ¨¡å¼ï¼šå°†è¦†ç›–æ‰€æœ‰å·²å­˜åœ¨çš„æŠ¥å‘Š"
            FORCE_ARG="--force"
          fi

          # æ‰§è¡Œç”Ÿæˆ
          python3 analyze_with_ai_summary.py $START_ARG $END_ARG $AI_ARG $FORCE_ARG
          echo "âœ… Report generated successfully"

      - name: Create index redirect
        run: |
          echo "ğŸ“„ Creating index.html redirect to current week..."
          python3 generate_index.py

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Commit and push reports
        run: |
          git add docs/*.html docs/*.md
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            YEAR=$(date +%Y)
            WEEK=$(date +%V)
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "chore: Generate weekly report ${YEAR}W${WEEK}" -m "Generated by GitHub Actions" -m "Timestamp: ${TIMESTAMP}"
            git push
            echo "âœ… Reports committed and pushed"
          fi

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

  deploy:
    needs: generate-report
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
