name: Generate Weekly KVMARM Report

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Šä¸œå…«åŒº8ç‚¹ (UTC 0ç‚¹) è‡ªåŠ¨ç”Ÿæˆä¸Šå‘¨æŠ¥å‘Š
    - cron: '0 0 * * 1'

  workflow_dispatch:
    inputs:
      report_type:
        description: 'é€‰æ‹©è¦ç”Ÿæˆçš„æŠ¥å‘Šç±»å‹'
        required: true
        type: choice
        options:
          - 'å‘¨æŠ¥ï¼ˆä¸Šå‘¨å®Œæ•´æŠ¥å‘Šï¼‰'
          - 'æœ¬å‘¨æŠ¥å‘Š'
          - 'è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´'
        default: 'å‘¨æŠ¥ï¼ˆä¸Šå‘¨å®Œæ•´æŠ¥å‘Šï¼‰'
      start_date:
        description: 'èµ·å§‹æ—¥æœŸ (YYYY-MM-DDï¼Œä»…"è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´"æ—¶éœ€è¦å¡«å†™)'
        required: false
        type: string
      end_date:
        description: 'ç»“æŸæ—¥æœŸ (YYYY-MM-DDï¼Œä»…"è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´"æ—¶éœ€è¦ï¼Œä¸å¡«é»˜è®¤ä¸ºä»Šå¤©)'
        required: false
        type: string
      force_regenerate:
        description: 'å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼ˆè¦†ç›–å·²å­˜åœ¨çš„å†å²æŠ¥å‘Šï¼Œé€‚ç”¨äºæ‰€æœ‰æŠ¥å‘Šç±»å‹ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install openai anthropic

      - name: Clone KVMARM mailing list
        run: |
          echo "ğŸ“¥ Cloning KVMARM mailing list repository..."
          mkdir -p git
          if [ -d "git/0.git" ]; then
            echo "Repository exists, fetching updates..."
            cd git/0.git
            git fetch --all
            cd ../..
          else
            git clone --mirror https://lore.kernel.org/kvmarm/0 git/0.git
          fi
          du -sh git/0.git
          echo "âœ… Mailing list repository ready"

      - name: Generate weekly report
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ¤– Generating weekly report..."

          # è®¾ç½®æ—¥æœŸå‚æ•°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘
            REPORT_TYPE="${{ inputs.report_type }}"

            if [ "$REPORT_TYPE" = "å‘¨æŠ¥ï¼ˆä¸Šå‘¨å®Œæ•´æŠ¥å‘Šï¼‰" ]; then
              # ç”Ÿæˆä¸Šå‘¨å®Œæ•´æŠ¥å‘Šï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
              LAST_WEEK_MONDAY=$(date -d 'monday-1 week' +%Y-%m-%d)
              LAST_WEEK_SUNDAY=$(date -d "${LAST_WEEK_MONDAY} +6 days" +%Y-%m-%d)
              LAST_YEAR=$(date -d "${LAST_WEEK_MONDAY}" +%G)
              LAST_WEEK=$(date -d "${LAST_WEEK_MONDAY}" +%V)
              START_ARG="--start ${LAST_WEEK_MONDAY}"
              END_ARG="--end ${LAST_WEEK_SUNDAY}"
              echo "ğŸ“… æ‰‹åŠ¨è§¦å‘ - å‘¨æŠ¥ï¼ˆä¸Šå‘¨ï¼‰: ${LAST_YEAR}å¹´ç¬¬${LAST_WEEK}å‘¨ (${LAST_WEEK_MONDAY} åˆ° ${LAST_WEEK_SUNDAY})"

            elif [ "$REPORT_TYPE" = "æœ¬å‘¨æŠ¥å‘Š" ]; then
              # ç”Ÿæˆæœ¬å‘¨æŠ¥å‘Šï¼ˆæœ¬å‘¨ä¸€åˆ°ä»Šå¤©ï¼‰
              THIS_WEEK_MONDAY=$(date -d 'monday' +%Y-%m-%d)
              THIS_WEEK_SUNDAY=$(date -d "${THIS_WEEK_MONDAY} +6 days" +%Y-%m-%d)
              THIS_YEAR=$(date -d "${THIS_WEEK_MONDAY}" +%G)
              THIS_WEEK=$(date -d "${THIS_WEEK_MONDAY}" +%V)
              START_ARG="--start ${THIS_WEEK_MONDAY}"
              END_ARG="--end ${THIS_WEEK_SUNDAY}"
              echo "ğŸ“… æ‰‹åŠ¨è§¦å‘ - æœ¬å‘¨æŠ¥å‘Š: ${THIS_YEAR}å¹´ç¬¬${THIS_WEEK}å‘¨ (${THIS_WEEK_MONDAY} åˆ° ${THIS_WEEK_SUNDAY})"

            else
              # è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
              if [ -n "${{ inputs.start_date }}" ]; then
                START_ARG="--start ${{ inputs.start_date }}"
                END_ARG=""
                # ç»“æŸæ—¥æœŸï¼šå¦‚æœæä¾›åˆ™ä½¿ç”¨ï¼Œå¦åˆ™é»˜è®¤ä¸ºä»Šå¤©
                if [ -n "${{ inputs.end_date }}" ]; then
                  END_ARG="--end ${{ inputs.end_date }}"
                  echo "ğŸ“… æ‰‹åŠ¨è§¦å‘ - è‡ªå®šä¹‰æ—¥æœŸ: ${{ inputs.start_date }} åˆ° ${{ inputs.end_date }}"
                else
                  TODAY=$(date +%Y-%m-%d)
                  END_ARG="--end ${TODAY}"
                  echo "ğŸ“… æ‰‹åŠ¨è§¦å‘ - è‡ªå®šä¹‰æ—¥æœŸ: ${{ inputs.start_date }} åˆ° ${TODAY} (é»˜è®¤åˆ°ä»Šå¤©)"
                fi
              else
                echo "âŒ é”™è¯¯ï¼šé€‰æ‹©è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´æ—¶å¿…é¡»æä¾›èµ·å§‹æ—¥æœŸ"
                exit 1
              fi
            fi
          else
            # å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å‘¨ä¸€ä¸œå…«åŒº8ç‚¹ï¼‰ï¼šç”Ÿæˆä¸Šå‘¨çš„å®Œæ•´æŠ¥å‘Š
            LAST_WEEK_MONDAY=$(date -d 'monday-1 week' +%Y-%m-%d)
            LAST_WEEK_SUNDAY=$(date -d "${LAST_WEEK_MONDAY} +6 days" +%Y-%m-%d)
            LAST_YEAR=$(date -d "${LAST_WEEK_MONDAY}" +%G)
            LAST_WEEK=$(date -d "${LAST_WEEK_MONDAY}" +%V)
            START_ARG="--start ${LAST_WEEK_MONDAY}"
            END_ARG="--end ${LAST_WEEK_SUNDAY}"
            echo "ğŸ“… å®šæ—¶ä»»åŠ¡ - å‘¨æŠ¥ï¼ˆä¸Šå‘¨ï¼‰: ${LAST_YEAR}å¹´ç¬¬${LAST_WEEK}å‘¨ (${LAST_WEEK_MONDAY} åˆ° ${LAST_WEEK_SUNDAY})"
          fi
          
          # è‡ªåŠ¨æ£€æµ‹æ˜¯å¦ä½¿ç”¨ AI
          if [ -n "$OPENAI_API_KEY" ]; then
            echo "âœ… æ£€æµ‹åˆ° OPENAI_API_KEYï¼Œä½¿ç”¨ AI æ€»ç»“"
            AI_ARG="--ai openai --model gpt-4o-mini"
          else
            echo "â„¹ï¸  æœªæ£€æµ‹åˆ° OPENAI_API_KEYï¼Œä½¿ç”¨åŸºäºè§„åˆ™çš„æ€»ç»“"
            AI_ARG="--ai none"
          fi

          # æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
          FORCE_ARG=""
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # å®šæ—¶ä»»åŠ¡ï¼šå¼ºåˆ¶è¦†ç›–ä¸Šå‘¨æŠ¥å‘Šï¼ˆç¡®ä¿æ•°æ®æœ€å®Œæ•´ï¼‰
            echo "ğŸ”„ å®šæ—¶ä»»åŠ¡æ¨¡å¼ï¼šå°†å¼ºåˆ¶è¦†ç›–ä¸Šå‘¨æŠ¥å‘Š"
            FORCE_ARG="--force"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.force_regenerate }}" = "true" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šæŒ‰ç”¨æˆ·é€‰æ‹©å†³å®šæ˜¯å¦å¼ºåˆ¶è¦†ç›–
            echo "ğŸ”„ å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ¨¡å¼ï¼šå°†è¦†ç›–æ‰€æœ‰å·²å­˜åœ¨çš„æŠ¥å‘Š"
            FORCE_ARG="--force"
          fi

          # æ‰§è¡Œç”Ÿæˆ
          python3 analyze_with_ai_summary.py $START_ARG $END_ARG $AI_ARG $FORCE_ARG
          echo "âœ… Report generated successfully"

      - name: Create index redirect
        run: |
          echo "ğŸ“„ Creating index.html redirect to current week..."
          python3 generate_index.py

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Commit and push reports
        run: |
          git add docs/*.html docs/*.md

          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            YEAR=$(date +%Y)
            WEEK=$(date +%V)
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "chore: Generate weekly report ${YEAR}W${WEEK}" -m "Generated by GitHub Actions" -m "Timestamp: ${TIMESTAMP}"

            # Pull with rebase to handle any remote changes
            echo "ğŸ“¥ Pulling remote changes..."
            git pull --rebase origin main

            # Push the changes
            git push
            echo "âœ… Reports committed and pushed"
          fi

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

  deploy:
    needs: generate-report
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
