name: Generate Weekly KVMARM Report

on:
  schedule:
    - cron: '0 1 * * 1'
  
  workflow_dispatch:
    inputs:
      start_date:
        description: '起始日期 (YYYY-MM-DD, 可选，默认生成本周)'
        required: false
        type: string
      end_date:
        description: '结束日期 (YYYY-MM-DD, 可选，默认到今天)'
        required: false
        type: string
      force_regenerate:
        description: '强制重新生成（覆盖已存在的历史报告）'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install openai anthropic

      - name: Clone KVMARM mailing list
        run: |
          echo "📥 Cloning KVMARM mailing list repository..."
          mkdir -p git
          if [ -d "git/0.git" ]; then
            echo "Repository exists, fetching updates..."
            cd git/0.git
            git fetch --all
            cd ../..
          else
            git clone --mirror https://lore.kernel.org/kvmarm/0 git/0.git
          fi
          du -sh git/0.git
          echo "✅ Mailing list repository ready"

      - name: Generate weekly report
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "🤖 Generating weekly report..."
          
          # 设置日期参数
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # 手动触发
            if [ -n "${{ inputs.start_date }}" ]; then
              START_ARG="--start ${{ inputs.start_date }}"
              END_ARG=""
              if [ -n "${{ inputs.end_date }}" ]; then
                END_ARG="--end ${{ inputs.end_date }}"
              fi
            else
              START_ARG=""
              END_ARG=""
            fi
          else
            # 定时触发（周一）：生成上周的完整报告
            # 计算上周的周一和周日
            LAST_WEEK_MONDAY=$(date -d 'monday-1 week' +%Y-%m-%d)
            LAST_WEEK_SUNDAY=$(date -d "${LAST_WEEK_MONDAY} +6 days" +%Y-%m-%d)
            LAST_YEAR=$(date -d "${LAST_WEEK_MONDAY}" +%G)
            LAST_WEEK=$(date -d "${LAST_WEEK_MONDAY}" +%V)
            START_ARG="--start ${LAST_WEEK_MONDAY}"
            END_ARG="--end ${LAST_WEEK_SUNDAY}"
            echo "📅 生成上周报告: ${LAST_YEAR}年第${LAST_WEEK}周 (${LAST_WEEK_MONDAY} 到 ${LAST_WEEK_SUNDAY})"
          fi
          
          # 自动检测是否使用 AI
          if [ -n "$OPENAI_API_KEY" ]; then
            echo "✅ 检测到 OPENAI_API_KEY，使用 AI 总结"
            AI_ARG="--ai openai --model gpt-4o-mini"
          else
            echo "ℹ️  未检测到 OPENAI_API_KEY，使用基于规则的总结"
            AI_ARG="--ai none"
          fi

          # 检查是否强制重新生成
          FORCE_ARG=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.force_regenerate }}" = "true" ]; then
            echo "🔄 强制重新生成模式：将覆盖所有已存在的报告"
            FORCE_ARG="--force"
          fi

          # 执行生成
          python3 analyze_with_ai_summary.py $START_ARG $END_ARG $AI_ARG $FORCE_ARG
          echo "✅ Report generated successfully"

      - name: Create index redirect
        run: |
          echo "📄 Creating index.html redirect to current week..."
          python3 generate_index.py

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Commit and push reports
        run: |
          git add docs/*.html docs/*.md

          if git diff --staged --quiet; then
            echo "ℹ️  No changes to commit"
          else
            YEAR=$(date +%Y)
            WEEK=$(date +%V)
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "chore: Generate weekly report ${YEAR}W${WEEK}" -m "Generated by GitHub Actions" -m "Timestamp: ${TIMESTAMP}"

            # Pull with rebase to handle any remote changes
            echo "📥 Pulling remote changes..."
            git pull --rebase origin main

            # Push the changes
            git push
            echo "✅ Reports committed and pushed"
          fi

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

  deploy:
    needs: generate-report
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
